<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrador Productos</title>
    <link rel="stylesheet" href="../Vista/AdminProducto.css" />
  </head>
  <body>
    <!--Cuerpo de la pagina-->
    <div class="cuerpo">
      <div class="user">
        <div class="datosPersonales">
          <div class="imagenUser">
            <img
              src="../img/person-svgrepo-com.svg"
              id="imgUsuario"
              alt="imgdelUsuario"
            />
          </div>
          <div class="infoUser">
            <p id="nombre">Administrador</p>
            <p id="correo">Ejemplo@hotmail.com</p>
          </div>
        </div>
        <div class="opciones">
                <div class="opcuerpo">
                    <button class="opcButton" onclick="abrirPagina('AccesoPage.html')" type="button">Administracion    
                    <svg width="24px" height="24px" viewBox="-4.5 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <title>arrow_right [#336]</title>
                        <desc>Created with Sketch.</desc>
                        <defs></defs>
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="Dribbble-Light-Preview" transform="translate(-305.000000, -6679.000000)" fill="#000000">
                                <g id="icons" transform="translate(56.000000, 160.000000)">
                                    <path d="M249.365851,6538.70769 L249.365851,6538.70769 C249.770764,6539.09744 250.426289,6539.09744 250.830166,6538.70769 L259.393407,6530.44413 C260.202198,6529.66364 260.202198,6528.39747 259.393407,6527.61699 L250.768031,6519.29246 C250.367261,6518.90671 249.720021,6518.90172 249.314072,6519.28247 L249.314072,6519.28247 C248.899839,6519.67121 248.894661,6520.31179 249.302681,6520.70653 L257.196934,6528.32352 C257.601847,6528.71426 257.601847,6529.34685 257.196934,6529.73759 L249.365851,6537.29462 C248.960938,6537.68437 248.960938,6538.31795 249.365851,6538.70769" id="arrow_right-[#336]">
                                    </path></g></g></g>
                    </svg>
                    </button>
                    <button class="opcButton" onclick="abrirPagina('AdminProducto.html')" type="button">Productos    
                        <svg width="24px" height="24px" viewBox="-4.5 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                            <title>arrow_right [#336]</title>
                            <desc>Created with Sketch.</desc>
                            <defs></defs>
                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <g id="Dribbble-Light-Preview" transform="translate(-305.000000, -6679.000000)" fill="#000000">
                                    <g id="icons" transform="translate(56.000000, 160.000000)">
                                        <path d="M249.365851,6538.70769 L249.365851,6538.70769 C249.770764,6539.09744 250.426289,6539.09744 250.830166,6538.70769 L259.393407,6530.44413 C260.202198,6529.66364 260.202198,6528.39747 259.393407,6527.61699 L250.768031,6519.29246 C250.367261,6518.90671 249.720021,6518.90172 249.314072,6519.28247 L249.314072,6519.28247 C248.899839,6519.67121 248.894661,6520.31179 249.302681,6520.70653 L257.196934,6528.32352 C257.601847,6528.71426 257.601847,6529.34685 257.196934,6529.73759 L249.365851,6537.29462 C248.960938,6537.68437 248.960938,6538.31795 249.365851,6538.70769" id="arrow_right-[#336]">
                                        </path></g></g> </g>
                        </svg>
                    </button>
                    <button class="opcButton">Ventas
                        <svg width="24px" height="24px" viewBox="-4.5 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                            <title>arrow_right [#336]</title>
                            <desc>Created with Sketch.</desc>
                            <defs></defs>
                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <g id="Dribbble-Light-Preview" transform="translate(-305.000000, -6679.000000)" fill="#000000">
                                    <g id="icons" transform="translate(56.000000, 160.000000)">
                                        <path d="M249.365851,6538.70769 L249.365851,6538.70769 C249.770764,6539.09744 250.426289,6539.09744 250.830166,6538.70769 L259.393407,6530.44413 C260.202198,6529.66364 260.202198,6528.39747 259.393407,6527.61699 L250.768031,6519.29246 C250.367261,6518.90671 249.720021,6518.90172 249.314072,6519.28247 L249.314072,6519.28247 C248.899839,6519.67121 248.894661,6520.31179 249.302681,6520.70653 L257.196934,6528.32352 C257.601847,6528.71426 257.601847,6529.34685 257.196934,6529.73759 L249.365851,6537.29462 C248.960938,6537.68437 248.960938,6538.31795 249.365851,6538.70769" id="arrow_right-[#336]">
                                        </path></g></g> </g>
                        </svg>
                    </button>
                    <button class="opcButton" onclick="abrirPagina('AdminProveedores.html')" type="button">Proveedores  
                        <svg width="24px" height="24px" viewBox="-4.5 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                            <title>arrow_right [#336]</title>
                            <desc>Created with Sketch.</desc>
                            <defs></defs>
                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <g id="Dribbble-Light-Preview" transform="translate(-305.000000, -6679.000000)" fill="#000000">
                                    <g id="icons" transform="translate(56.000000, 160.000000)">
                                        <path d="M249.365851,6538.70769 L249.365851,6538.70769 C249.770764,6539.09744 250.426289,6539.09744 250.830166,6538.70769 L259.393407,6530.44413 C260.202198,6529.66364 260.202198,6528.39747 259.393407,6527.61699 L250.768031,6519.29246 C250.367261,6518.90671 249.720021,6518.90172 249.314072,6519.28247 L249.314072,6519.28247 C248.899839,6519.67121 248.894661,6520.31179 249.302681,6520.70653 L257.196934,6528.32352 C257.601847,6528.71426 257.601847,6529.34685 257.196934,6529.73759 L249.365851,6537.29462 C248.960938,6537.68437 248.960938,6538.31795 249.365851,6538.70769" id="arrow_right-[#336]">
                                        </path></g></g> </g>
                        </svg>
                    </button>
                    <button class="opcButton" onclick="abrirPagina('AdminUsuario.html')">Usuarios 
                        <svg width="24px" height="24px" viewBox="-4.5 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                            <title>arrow_right [#336]</title>
                            <desc>Created with Sketch.</desc>
                            <defs></defs>
                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <g id="Dribbble-Light-Preview" transform="translate(-305.000000, -6679.000000)" fill="#000000">
                                    <g id="icons" transform="translate(56.000000, 160.000000)">
                                        <path d="M249.365851,6538.70769 L249.365851,6538.70769 C249.770764,6539.09744 250.426289,6539.09744 250.830166,6538.70769 L259.393407,6530.44413 C260.202198,6529.66364 260.202198,6528.39747 259.393407,6527.61699 L250.768031,6519.29246 C250.367261,6518.90671 249.720021,6518.90172 249.314072,6519.28247 L249.314072,6519.28247 C248.899839,6519.67121 248.894661,6520.31179 249.302681,6520.70653 L257.196934,6528.32352 C257.601847,6528.71426 257.601847,6529.34685 257.196934,6529.73759 L249.365851,6537.29462 C248.960938,6537.68437 248.960938,6538.31795 249.365851,6538.70769" id="arrow_right-[#336]">
                                        </path></g></g> </g>
                        </svg>
                    </button>                
                    <button class="cerrarButton" onclick="abrirPagina('Home.html')" type="button">
                        SALIR
                    </button>                   
                </div>
            </div>
      </div>
      <div class="contenido">
        <div class="infoCont">
          <div class="titulo">
            <h2>PRODUCTO:</h2>
          </div>
          <div class="subTitulo">
            <p>Todos los productos:</p>
            <div class="barra-busqueda">
              <img
                src="../img/busqueda.png"
                alt="Buscar"
                width="20"
                height="20"
              />
              <input type="text" placeholder="Buscar..." />
            </div>
            <a href="Reguister_prouctos.html" class="añadirButton">
              <div class="añadir">Añadir +</div>
            </a>
          </div>
        </div>
        <div class="cont">
          <!-- Contenedor dinámico para los productos -->
          <div id="productos-container">
            <!-- Los productos se cargarán aquí dinámicamente -->
            <p>Cargando productos...</p>
          </div>
        </div>
      </div>
    </div>
    <!-- Aqui el modal editar producto-->

    <div id="modalEditarProducto" class="modal-overlay" style="display: none">
      <div class="form-container">
        <button
          class="close-modal-btn"
          id="cerrarModalEditar"
          aria-label="Cerrar"
        >
          ×
        </button>
        <h1>Actualiza el Producto</h1>
        <p>
          Completa los siguientes campos actualizar el artículo del catálogo.
        </p>
        <form id="formRegistrarProducto" class="product-form">
          <div class="form-group">
            <label for="productName">Nombre del Producto</label>
            <input
              type="text"
              id="productName"
              name="nombre"
              placeholder="Ej: Mouse Gamer Inalámbrico"
              required
            />
          </div>
          <div class="form-group">
            <label for="productBrand">Marca</label>
            <input
              type="text"
              id="productBrand"
              name="marca"
              placeholder="Ej: Logitech"
              required
            />
          </div>
          <div class="form-group">
            <label for="productDescription">Descripción</label>
            <textarea
              id="productDescription"
              name="descripcion"
              rows="5"
              placeholder="Describe las características principales del producto."
              required
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="productPrice">Precio (S/)</label>
              <input
                type="number"
                id="productPrice"
                name="precio"
                step="0.01"
                placeholder="Ej: 199.90"
                required
              />
            </div>
            <div class="form-group">
              <label for="productStock">Stock</label>
              <input
                type="number"
                id="productStock"
                name="stock"
                placeholder="Ej: 50"
                required
              />
            </div>
          </div>
          <button type="submit" class="submit-btn">Actualizar Producto</button>
        </form>
      </div>
    </div>

    <!-- Modal para confirmar eliminación -->
    <div id="modalEliminarProducto" class="modal-overlay" style="display: none">
      <div class="confirm-container">
        <button
          class="close-modal-btn"
          id="cerrarModalEliminar"
          aria-label="Cerrar"
        >
          ×
        </button>
        <div class="confirm-content">
          <div class="confirm-icon">
            <!-- Puedes usar un ícono SVG de advertencia aquí si deseas -->
            <svg width="38" height="38" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="12" fill="#ff4d4f" />
              <path
                d="M12 7v5M12 16h.01"
                stroke="#fff"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </div>
          <div>
            <h2 class="confirm-title">¿Eliminar producto?</h2>
            <p class="confirm-text">
              Esta acción no se puede deshacer. ¿Seguro que deseas eliminar este
              producto?
            </p>
            <div class="confirm-actions">
              <button class="submit-btn eliminar-btn" id="confirmarEliminar">
                Eliminar
              </button>
              <button class="submit-btn cancelar-btn" id="cancelarEliminar">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!-- Scripts para cargar productos dinámicamente -->
  <script src="../Controlador/Shared/config.js"></script>
  <script src="../Controlador/getProductoControlles.js" onerror="console.error('❌ Error cargando getProductoControlles.js')" onload="console.log('✅ getProductoControlles.js cargado')"></script>
  <script src="../Controlador/modificarProducto.js" onerror="console.error('❌ Error cargando modificarProducto.js')" onload="console.log('✅ modificarProducto.js cargado')"></script>
  <script src="../Controlador/eliminarProducto.js" onerror="console.error('❌ Error cargando eliminarProducto.js')" onload="console.log('✅ eliminarProducto.js cargado')"></script>
  <script>
    function abrirPagina(url) {
      window.location.href = url;
    }

    // Función personalizada para renderizar productos en el estilo del admin
    async function renderizarProductosAdmin() {
      const container = document.getElementById('productos-container');
      if (!container) {
        console.error('Contenedor productos-container no encontrado');
        return;
      }

      try {
        // Mostrar loading
        container.innerHTML = '<p>Cargando productos...</p>';
        
        // Obtener productos con imágenes
        const productosConImagenes = await obtenerProductosConImagenes();
        
        // Limpiar container
        container.innerHTML = '';
        
        // Renderizar cada producto en el estilo del admin
        productosConImagenes.forEach(({ producto, imagenes }) => {
          // Obtener la imagen principal o la primera imagen
          const imagenPrincipal = imagenes.find(img => img.es_principal) || imagenes[0];
          const srcImagen = imagenPrincipal ? imagenPrincipal.url_completa : '../img/placeholder.jpg';
          
          const productoDiv = document.createElement('div');
          productoDiv.className = 'productos';
          // Agregar todos los datos del producto como atributos data-*
          productoDiv.setAttribute('data-producto-id', producto.id);
          productoDiv.setAttribute('data-producto-nombre', producto.nombre || '');
          productoDiv.setAttribute('data-producto-marca', producto.marca || '');
          productoDiv.setAttribute('data-producto-descripcion', producto.descripcion || '');
          productoDiv.setAttribute('data-producto-precio', producto.precio || '');
          productoDiv.setAttribute('data-producto-stock', producto.stock || '');
          productoDiv.setAttribute('data-producto-disponible', producto.disponible || false);
          productoDiv.setAttribute('data-producto-imagen', srcImagen);
          
          productoDiv.innerHTML = `
            <div class="content-img">
              <img class="img-product" src="${srcImagen}" alt="${producto.nombre}">
            </div>
            <div class="infoProduct">
              <div class="infoProductMax">
                <div class="nombre">
                  <p>${producto.nombre}</p>
                </div>
                <div class="precio">
                  <p>S/${producto.precio}</p>
                </div>
                <!-- Información adicional oculta para acceso desde DOM -->
                <div class="datos-ocultos" style="display: none;">
                  <span class="marca">${producto.marca || ''}</span>
                  <span class="descripcion">${producto.descripcion || ''}</span>
                  <span class="stock">${producto.stock || ''}</span>
                  <span class="disponible">${producto.disponible || false}</span>
                </div>
              </div>
              <div class="nav-item">
                <span class="tresPuntos" data-producto-id="${producto.id}">...</span>
                <div class="dropdown-menu">
                  <a href="#" class="dropdown-item" onclick="editarProducto(${producto.id})">Modificar</a>
                  <a href="#" class="dropdown-item" onclick="eliminarProducto(${producto.id})">Eliminar</a>
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(productoDiv);
        });
        
        if (productosConImagenes.length === 0) {
          container.innerHTML = '<p>No se encontraron productos</p>';
        }
        
        // Reactivar los event listeners para los dropdowns
        activarDropdowns();
        
      } catch (error) {
        console.error('Error al renderizar productos:', error);
        container.innerHTML = '<p>Error al cargar productos</p>';
      }
    }

    // Función para activar los dropdowns
    function activarDropdowns() {
      document.querySelectorAll('.tresPuntos').forEach(function(span) {
        span.addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = this.nextElementSibling;
          // Cerrar otros dropdowns
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            if (menu !== dropdown) {
              menu.style.display = 'none';
            }
          });
          // Toggle del dropdown actual
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
      });

      // Cerrar dropdowns al hacer click fuera
      document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
          menu.style.display = 'none';
        });
      });
    }

    // Variable global para almacenar el ID del producto a eliminar
    let productoIdAEliminar = null;

    // Funciones para editar y eliminar productos
    function editarProducto(id) {
      console.log('🔧 Iniciando edición de producto ID:', id);
      
      // 1. Intentar extraer datos del DOM primero
      const datosDOM = extraerDatosProductoDelDOM(id);
      
      // 2. Abrir modal
      const modal = document.getElementById('modalEditarProducto');
      if (!modal) {
        console.error('❌ Modal no encontrado');
        return;
      }
      
      modal.style.display = 'flex';
      
      // 3. Si hay datos del DOM, llenar el formulario inmediatamente
      if (datosDOM) {
        console.log('✅ Llenando formulario con datos del DOM:', datosDOM);
        llenarFormularioConDatos(datosDOM, id);
      }
      
      // 4. Si está disponible la función de modificarProducto.js, usarla para obtener datos adicionales
      if (typeof window.editarProductoModal === 'function') {
        console.log('✅ También ejecutando función de modificarProducto.js para datos completos');
        // No llamamos window.editarProductoModal(id) porque ya abrimos el modal
        // En su lugar, solo obtenemos los datos de Supabase si es necesario
        if (typeof window.cargarDatosProductoDesdeSupabase === 'function') {
          window.cargarDatosProductoDesdeSupabase(id);
        }
      } else {
        console.warn('⚠️ Función editarProductoModal no disponible, usando solo datos del DOM');
        // Configurar el formulario para edición
        const form = document.getElementById('formRegistrarProducto');
        if (form) {
          form.setAttribute('data-producto-id', id);
        }
      }
    }

    // Función para extraer datos del producto desde el DOM
    function extraerDatosProductoDelDOM(id) {
      try {
        // Método 1: Buscar por atributo data-producto-id en el contenedor principal
        let contenedorProducto = document.querySelector(`[data-producto-id="${id}"].productos`);
        
        // Método 2: Si no se encuentra, buscar el span con data-producto-id y navegar al contenedor
        if (!contenedorProducto) {
          const elementoProducto = document.querySelector(`span[data-producto-id="${id}"]`);
          if (elementoProducto) {
            contenedorProducto = elementoProducto.closest('.productos');
          }
        }

        if (!contenedorProducto) {
          console.warn('⚠️ No se encontró contenedor del producto para el ID:', id);
          return null;
        }

        // Extraer datos desde atributos data-* (método preferido)
        const datosAtributos = {
          id: id,
          nombre: contenedorProducto.getAttribute('data-producto-nombre') || '',
          marca: contenedorProducto.getAttribute('data-producto-marca') || '',
          descripcion: contenedorProducto.getAttribute('data-producto-descripcion') || '',
          precio: contenedorProducto.getAttribute('data-producto-precio') || '',
          stock: contenedorProducto.getAttribute('data-producto-stock') || '',
          disponible: contenedorProducto.getAttribute('data-producto-disponible') === 'true',
          imagen: contenedorProducto.getAttribute('data-producto-imagen') || ''
        };

        // Si los atributos tienen datos, usarlos
        if (datosAtributos.nombre) {
          console.log('✅ Datos extraídos del DOM (atributos data-*):', datosAtributos);
          return datosAtributos;
        }

        // Método fallback: extraer desde elementos DOM visibles
        const nombre = contenedorProducto.querySelector('.nombre p')?.textContent?.trim();
        const precioTexto = contenedorProducto.querySelector('.precio p')?.textContent?.trim();
        const precio = precioTexto ? precioTexto.replace('S/', '').trim() : '';
        const imagenSrc = contenedorProducto.querySelector('.img-product')?.src;

        // Intentar extraer datos ocultos
        const datosOcultos = contenedorProducto.querySelector('.datos-ocultos');
        let marca = '', descripcion = '', stock = '', disponible = false;
        
        if (datosOcultos) {
          marca = datosOcultos.querySelector('.marca')?.textContent?.trim() || '';
          descripcion = datosOcultos.querySelector('.descripcion')?.textContent?.trim() || '';
          stock = datosOcultos.querySelector('.stock')?.textContent?.trim() || '';
          disponible = datosOcultos.querySelector('.disponible')?.textContent?.trim() === 'true';
        }

        const datosFallback = {
          id: id,
          nombre: nombre || '',
          marca: marca,
          descripcion: descripcion,
          precio: precio || '',
          stock: stock,
          disponible: disponible,
          imagen: imagenSrc || ''
        };

        console.log('✅ Datos extraídos del DOM (fallback):', datosFallback);
        return datosFallback;

      } catch (error) {
        console.error('❌ Error al extraer datos del DOM:', error);
        return null;
      }
    }

    // Función para llenar el formulario con los datos extraídos
    function llenarFormularioConDatos(datos, id) {
      try {
        const form = document.getElementById('formRegistrarProducto');
        if (!form) {
          console.error('❌ Formulario no encontrado');
          return;
        }

        // Configurar el formulario para edición
        form.setAttribute('data-producto-id', id);

        // Mapeo de campos del formulario
        const campos = {
          'nombreProducto': datos.nombre,
          'marcaProducto': datos.marca,
          'descripcionProducto': datos.descripcion,
          'precioProducto': datos.precio,
          'stockProducto': datos.stock,
          'disponibleProducto': datos.disponible
        };

        // Llenar campos de texto y select
        Object.keys(campos).forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field && campos[fieldId] !== undefined && campos[fieldId] !== '') {
            if (field.type === 'checkbox') {
              field.checked = Boolean(campos[fieldId]);
            } else {
              field.value = campos[fieldId];
            }
            
            // Agregar efecto visual de carga exitosa
            field.style.borderColor = '#28a745';
            field.style.backgroundColor = '#f8fff9';
            setTimeout(() => {
              field.style.borderColor = '';
              field.style.backgroundColor = '';
            }, 2000);
            
            console.log(`✅ Campo ${fieldId} llenado con: ${campos[fieldId]}`);
          }
        });

        // Si hay imagen disponible, mostrarla como preview
        if (datos.imagen) {
          mostrarPreviewImagen(datos.imagen);
        }

        // Mostrar indicador de éxito
        mostrarNotificacionEnFormulario('Datos básicos cargados desde la página', 'success');

        console.log('✅ Formulario llenado con datos del DOM');

      } catch (error) {
        console.error('❌ Error al llenar formulario:', error);
      }
    }

    // Función auxiliar para mostrar notificación en el formulario
    function mostrarNotificacionEnFormulario(mensaje, tipo = 'info') {
      try {
        // Remover notificación anterior si existe
        const notificacionAnterior = document.getElementById('notificacion-formulario');
        if (notificacionAnterior) {
          notificacionAnterior.remove();
        }

        // Crear nueva notificación
        const notificacion = document.createElement('div');
        notificacion.id = 'notificacion-formulario';
        notificacion.textContent = mensaje;
        
        const colores = {
          'success': { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
          'warning': { bg: '#fff3cd', color: '#856404', border: '#ffeaa7' },
          'error': { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
          'info': { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
        };

        const estilo = colores[tipo] || colores.info;
        
        notificacion.style.cssText = `
          background-color: ${estilo.bg};
          color: ${estilo.color};
          border: 1px solid ${estilo.border};
          padding: 10px;
          border-radius: 5px;
          margin: 10px 0;
          font-size: 14px;
          animation: fadeIn 0.3s ease-in;
        `;

        // Insertar al inicio del formulario
        const form = document.getElementById('formRegistrarProducto');
        if (form) {
          form.insertBefore(notificacion, form.firstChild);
          
          // Auto-remover después de 5 segundos
          setTimeout(() => {
            if (notificacion && notificacion.parentNode) {
              notificacion.style.animation = 'fadeOut 0.3s ease-out';
              setTimeout(() => notificacion.remove(), 300);
            }
          }, 5000);
        }

      } catch (error) {
        console.error('❌ Error al mostrar notificación:', error);
      }
    }

    // Función auxiliar para mostrar preview de imagen
    function mostrarPreviewImagen(imagenSrc) {
      try {
        // Buscar o crear elemento de preview
        let preview = document.getElementById('imagen-preview');
        if (!preview) {
          preview = document.createElement('img');
          preview.id = 'imagen-preview';
          preview.style.cssText = `
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
          `;
          
          // Insertar después del campo de imagen
          const campoImagen = document.getElementById('imagenProducto');
          if (campoImagen && campoImagen.parentNode) {
            campoImagen.parentNode.insertBefore(preview, campoImagen.nextSibling);
          }
        }
        
        preview.src = imagenSrc;
        preview.alt = 'Vista previa del producto';
        console.log('✅ Preview de imagen mostrado');
        
      } catch (error) {
        console.error('❌ Error al mostrar preview de imagen:', error);
      }
    }

    function eliminarProducto(id) {
      console.log('🗑️ Solicitando eliminar producto ID:', id);
      
      // Usar la función del script de eliminarProducto.js si está disponible
      if (typeof window.prepararEliminacion === 'function') {
        console.log('✅ Usando función de eliminarProducto.js');
        window.prepararEliminacion(id);
      } else {
        console.warn('⚠️ Función prepararEliminacion no disponible, usando fallback');
        // Fallback básico
        productoIdAEliminar = id;
      }
      
      // Abrir modal de confirmación
      document.getElementById('modalEliminarProducto').style.display = 'flex';
    }

    // Función para verificar que todos los scripts se hayan cargado correctamente
    function verificarScriptsCargados() {
      console.log('🔍 Verificando scripts cargados:');
      console.log('- getProductoControlles.js funciones disponibles:', typeof obtenerProductosConImagenes);
      console.log('- modificarProducto.js funciones disponibles:', typeof window.editarProductoModal);
      console.log('- eliminarProducto.js funciones disponibles:');
      console.log('  - confirmarEliminacionProducto:', typeof window.confirmarEliminacionProducto);
      console.log('  - prepararEliminacion:', typeof window.prepararEliminacion);
      console.log('  - eliminarProductoDeSupabase:', typeof window.eliminarProductoDeSupabase);
      
      // Si las funciones de eliminación no están disponibles, mostrar alerta
      if (typeof window.confirmarEliminacionProducto !== 'function' && 
          typeof window.eliminarProductoDeSupabase !== 'function') {
        console.warn('⚠️ ADVERTENCIA: Las funciones de eliminación no están disponibles');
        console.warn('⚠️ Esto significa que el script eliminarProducto.js no se cargó correctamente');
        
        // Intentar cargar el script manualmente
        console.log('🔄 Intentando cargar eliminarProducto.js manualmente...');
        cargarScriptManualmente();
      } else {
        console.log('✅ Todos los scripts de eliminación están disponibles');
      }
    }
    
    // Función para cargar el script manualmente si falla
    function cargarScriptManualmente() {
      try {
        const script = document.createElement('script');
        script.src = '../Controlador/eliminarProducto.js';
        script.onload = function() {
          console.log('✅ eliminarProducto.js cargado manualmente');
          // Verificar nuevamente
          setTimeout(verificarScriptsCargados, 100);
        };
        script.onerror = function(error) {
          console.error('❌ Error al cargar eliminarProducto.js manualmente:', error);
          console.error('💡 Posibles soluciones:');
          console.error('   1. Verificar que el archivo existe en ../Controlador/eliminarProducto.js');
          console.error('   2. Verificar permisos del archivo');
          console.error('   3. Verificar errores de sintaxis en el archivo');
          console.error('   4. Abrir la pestaña Network en DevTools para ver errores de carga');
        };
        document.head.appendChild(script);
      } catch (error) {
        console.error('❌ Error crítico al cargar script manualmente:', error);
      }
    }

    // Cargar productos al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📄 DOM Content Loaded - Inicializando página');
      
      // Verificar scripts
      setTimeout(verificarScriptsCargados, 500);
      
      // Cargar productos
      renderizarProductosAdmin();
    });

    // Modal editar producto - Cerrar
    document.getElementById('cerrarModalEditar').addEventListener('click', function() {
      document.getElementById('modalEditarProducto').style.display = 'none';
    });

    document.getElementById('modalEditarProducto').addEventListener('click', function(e) {
      if(e.target === this) {
        this.style.display = 'none';
      }
    });

    // Modal eliminar producto - Cerrar
    document.getElementById('cerrarModalEliminar').addEventListener('click', function() {
      document.getElementById('modalEliminarProducto').style.display = 'none';
      productoIdAEliminar = null;
    });

    document.getElementById('cancelarEliminar').addEventListener('click', function() {
      document.getElementById('modalEliminarProducto').style.display = 'none';
      productoIdAEliminar = null;
    });

    document.getElementById('modalEliminarProducto').addEventListener('click', function(e) {
      if(e.target === this) {
        this.style.display = 'none';
        productoIdAEliminar = null;
      }
    });

    // Confirmar eliminación
    document.getElementById('confirmarEliminar').addEventListener('click', async function() {
      console.log('🔄 Botón confirmar eliminar presionado');
      
      // Verificar si hay un producto seleccionado
      const productoId = productoIdAEliminar || window.productoIdAEliminar;
      
      if (productoId) {
        console.log('✅ Intentando eliminar producto ID:', productoId);
        
        // Verificar si las funciones de eliminación están disponibles
        console.log('🔍 Verificando funciones disponibles:');
        console.log('- window.confirmarEliminacionProducto:', typeof window.confirmarEliminacionProducto);
        console.log('- window.eliminarProductoDeSupabase:', typeof window.eliminarProductoDeSupabase);
        
        // Intentar usar la función principal de eliminación
        if (typeof window.confirmarEliminacionProducto === 'function') {
          console.log('✅ Usando función confirmarEliminacionProducto');
          await window.confirmarEliminacionProducto(productoId);
        } 
        // Fallback: usar función directa de eliminación
        else if (typeof window.eliminarProductoDeSupabase === 'function') {
          console.log('✅ Usando función eliminarProductoDeSupabase como fallback');
          try {
            const eliminado = await window.eliminarProductoDeSupabase(productoId);
            if (eliminado) {
              // Eliminar del DOM manualmente
              const contenedorProducto = document.querySelector(`[data-producto-id="${productoId}"].productos`);
              if (contenedorProducto) {
                contenedorProducto.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => {
                  contenedorProducto.remove();
                  console.log('✅ Producto eliminado del DOM');
                }, 500);
              }
              
              // Cerrar modal
              document.getElementById('modalEliminarProducto').style.display = 'none';
              productoIdAEliminar = null;
              window.productoIdAEliminar = null;
            }
          } catch (error) {
            console.error('❌ Error en eliminación directa:', error);
          }
        }
        // Último fallback: función integrada
        else {
          console.warn('⚠️ Scripts de eliminación no disponibles, usando fallback integrado');
          await eliminarProductoFallback(productoId);
        }
      } else {
        console.error('❌ No hay producto seleccionado para eliminar');
        alert('Error: No se ha seleccionado ningún producto para eliminar');
      }
    });

    // =======================================================
    // FUNCIONES DE DEBUG Y TESTING
    // =======================================================

    // Función para probar la extracción de datos del DOM
    window.debugExtraerDatos = function(id) {
      console.log('🧪 DEBUG: Probando extracción de datos para ID:', id);
      const datos = extraerDatosProductoDelDOM(id);
      console.log('🧪 DEBUG: Datos extraídos:', datos);
      return datos;
    };

    // Función para probar el llenado del formulario
    window.debugLlenarFormulario = function(id) {
      console.log('🧪 DEBUG: Probando llenado de formulario para ID:', id);
      const datos = extraerDatosProductoDelDOM(id);
      if (datos) {
        llenarFormularioConDatos(datos, id);
        console.log('🧪 DEBUG: Formulario llenado exitosamente');
      } else {
        console.error('🧪 DEBUG: No se pudieron extraer datos');
      }
    };

    // Función para listar todos los productos disponibles en el DOM
    window.debugListarProductos = function() {
      console.log('🧪 DEBUG: Listando productos en el DOM...');
      const productos = document.querySelectorAll('.productos[data-producto-id]');
      productos.forEach((producto, index) => {
        const id = producto.getAttribute('data-producto-id');
        const nombre = producto.getAttribute('data-producto-nombre');
        console.log(`🧪 DEBUG: Producto ${index + 1}: ID=${id}, Nombre=${nombre}`);
      });
      console.log(`🧪 DEBUG: Total de productos encontrados: ${productos.length}`);
      return productos;
    };

    // Función de debug para probar eliminación
    window.debugEliminar = function(id) {
      console.log('🧪 DEBUG: Probando eliminación completa para ID:', id);
      eliminarProducto(id);
    };

    // Función de debug para probar eliminación directa
    window.testEliminar = async function(id) {
      console.log('🧪 TEST: Eliminación directa para ID:', id);
      
      // Verificar funciones disponibles
      console.log('🔍 Funciones disponibles:');
      console.log('- window.eliminarProductoDeSupabase:', typeof window.eliminarProductoDeSupabase);
      console.log('- window.confirmarEliminacionProducto:', typeof window.confirmarEliminacionProducto);
      
      if (typeof window.eliminarProductoDeSupabase === 'function') {
        console.log('✅ Ejecutando eliminación directa...');
        const resultado = await window.eliminarProductoDeSupabase(id);
        console.log('🧪 TEST: Resultado:', resultado);
        return resultado;
      } else if (typeof eliminarProductoFallback === 'function') {
        console.log('✅ Ejecutando eliminación fallback...');
        const resultado = await eliminarProductoFallback(id);
        console.log('🧪 TEST: Resultado fallback:', resultado);
        return resultado;
      } else {
        console.error('❌ Ninguna función de eliminación disponible');
        return false;
      }
    };

    // Log de funciones disponibles
    console.log('🔧 Funciones de debug disponibles:');
    console.log('   - window.debugExtraerDatos(id)');
    console.log('   - window.debugLlenarFormulario(id)');
    console.log('   - window.debugListarProductos()');
    console.log('   - window.debugEliminar(id)');
    console.log('   - window.testEliminar(id)');
    console.log('   - window.testEliminar(id)');

    // =======================================================
    // FUNCIÓN DE ELIMINACIÓN FALLBACK (EN CASO DE QUE EL SCRIPT EXTERNO FALLE)
    // =======================================================
    
    // Función de eliminación completa como fallback
    async function eliminarProductoFallback(productoId) {
      console.log('🔄 Ejecutando eliminación fallback para ID:', productoId);
      
      try {
        // Mostrar indicador de carga
        const botonEliminar = document.getElementById('confirmarEliminar');
        const botonCancelar = document.getElementById('cancelarEliminar');
        
        if (botonEliminar) {
          botonEliminar.disabled = true;
          botonEliminar.textContent = 'Eliminando...';
        }
        if (botonCancelar) {
          botonCancelar.disabled = true;
        }

        // Obtener token de autenticación
        const token = document.cookie
          .split('; ')
          .find(row => row.startsWith('supabase_token='))
          ?.split('=')[1];
        
        if (!token) {
          throw new Error('No se encontró token de autenticación. Por favor, inicia sesión nuevamente.');
        }

        // Configurar headers para la petición
        const myHeaders = new Headers();
        myHeaders.append("apikey", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3YnBpcHRvbXFhdWd0YnhybGxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5ODAwNDQsImV4cCI6MjA2NjU1NjA0NH0.MkfOyv_39_GkSScVS28I0p8-2GGoAyTRH5LKSlKsQJA");
        myHeaders.append("Authorization", `Bearer ${token}`);
        myHeaders.append("Content-Type", "application/json");

        // Configurar opciones de la petición
        const requestOptions = {
          method: "DELETE",
          headers: myHeaders,
          redirect: "follow"
        };

        // Realizar petición DELETE a Supabase
        console.log('📡 Enviando petición DELETE a Supabase (fallback)...');
        const response = await fetch(
          `https://iwbpiptomqaugtbxrlln.supabase.co/rest/v1/productos?id=eq.${productoId}`,
          requestOptions
        );

        // Verificar respuesta
        if (!response.ok) {
          const errorText = await response.text();
          console.error('❌ Error en la respuesta de Supabase:', {
            status: response.status,
            statusText: response.statusText,
            body: errorText
          });

          if (response.status === 401) {
            throw new Error('Token de autenticación inválido o expirado. Por favor, inicia sesión nuevamente.');
          } else if (response.status === 403) {
            throw new Error('No tienes permisos para eliminar este producto.');
          } else if (response.status === 404) {
            throw new Error('El producto no fue encontrado o ya fue eliminado.');
          } else {
            throw new Error(`Error del servidor: ${response.status} - ${response.statusText}`);
          }
        }

        const result = await response.text();
        console.log('✅ Respuesta de Supabase (fallback):', result);

        // Obtener nombre del producto para el mensaje
        const contenedorProducto = document.querySelector(`[data-producto-id="${productoId}"].productos`);
        const nombreProducto = contenedorProducto ? 
          (contenedorProducto.getAttribute('data-producto-nombre') || 
           contenedorProducto.querySelector('.nombre p')?.textContent?.trim() || 
           `Producto ID: ${productoId}`) : 
          `Producto ID: ${productoId}`;

        // Mostrar notificación de éxito
        const notificacion = document.createElement('div');
        notificacion.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
          padding: 15px 20px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          max-width: 400px;
        `;
        notificacion.textContent = `✅ Producto "${nombreProducto}" eliminado exitosamente`;
        document.body.appendChild(notificacion);

        // Auto-remover notificación
        setTimeout(() => {
          if (notificacion && notificacion.parentNode) {
            notificacion.remove();
          }
        }, 5000);

        // Eliminar del DOM con animación
        if (contenedorProducto) {
          contenedorProducto.style.animation = 'fadeOut 0.5s ease-out';
          setTimeout(() => {
            contenedorProducto.remove();
            console.log('✅ Producto eliminado del DOM (fallback)');
            
            // Verificar si quedan productos
            const productosRestantes = document.querySelectorAll('.productos[data-producto-id]');
            if (productosRestantes.length === 0) {
              const container = document.getElementById('productos-container');
              if (container) {
                container.innerHTML = '<p>No se encontraron productos</p>';
              }
            }
          }, 500);
        }

        // Cerrar modal
        document.getElementById('modalEliminarProducto').style.display = 'none';
        productoIdAEliminar = null;

        console.log(`✅ Producto ${productoId} eliminado exitosamente (fallback)`);
        return true;

      } catch (error) {
        console.error('❌ Error en eliminación fallback:', error);
        
        // Restaurar botones
        const botonEliminar = document.getElementById('confirmarEliminar');
        const botonCancelar = document.getElementById('cancelarEliminar');
        
        if (botonEliminar) {
          botonEliminar.disabled = false;
          botonEliminar.textContent = 'Eliminar';
        }
        if (botonCancelar) {
          botonCancelar.disabled = false;
        }

        // Mostrar notificación de error
        const notificacion = document.createElement('div');
        notificacion.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
          padding: 15px 20px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          max-width: 400px;
        `;
        notificacion.textContent = `❌ Error al eliminar producto: ${error.message}`;
        document.body.appendChild(notificacion);

        // Auto-remover notificación
        setTimeout(() => {
          if (notificacion && notificacion.parentNode) {
            notificacion.remove();
          }
        }, 8000);

        return false;
      }
    }

    </script>
  </body>
</html>
